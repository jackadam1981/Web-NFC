<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        html, body {
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 10px;
            line-height: 1.6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .version {
            font-size: 14px;
            color: #666;
            font-weight: normal;
        }

        select {
            width: 100%;
            max-width: 600px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 0 auto 20px;
            display: block;
            background-color: white;
        }

        button {
            width: 80%;
            max-width: 600px;
            padding: 15px;
            font-size: 18px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            margin: 0 auto 20px;
            display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        button:active {
            background-color: #0056b3;
            transform: translateY(1px);
        }

        #nfc-output {
            width: 100%;
            max-width: 600px;
            font-size: 16px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 0 auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .result-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            gap: 10px;
            width: 100%;
        }

        #card-number {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            width: 100%;
            text-align: center;
        }

        .copy-button {
            width: 80%;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            margin: 0 auto;
            display: block;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .copy-button:active {
            background-color: #218838;
            transform: translateY(1px);
        }

        .copy-success {
            background-color: #218838;
        }

        .sector {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            overflow-x: auto;
        }

        .sector-header {
            font-weight: bold;
            color: #007bff;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px 0;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            .container {
                padding: 0 12px;
            }
            
            select, #nfc-output {
                max-width: 100%;
                width: 100%;
            }

            button {
                max-width: 100%;
                width: 80%;
            }

            .result-container {
                gap: 8px;
            }

            .copy-button {
                width: 80%;
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">吴氏手机读卡器<span class="version">v0.1</span></h1>
        <select id="readType" title="读卡类型选择">
            <option value="hex16_10">10位16进制</option>
            <option value="hex16_8">8位16进制</option>
            <option value="hex16_8_reverse">8位16进制反向输出</option>
            <option value="dec10_5">5位10进制（ID后2字节转换）</option>
            <option value="dec10_8_3">8位10进制（ID后3字节转换）</option>
            <option value="dec10_8_4">8位10进制（ID后4字节转换）</option>
            <option value="dec10_10_3" selected>10位10进制（ID后3字节转换）</option>
            <option value="dec10_10_4">10位10进制（ID后4字节转换）</option>
            <option value="dec10_10_4_reverse">10位10进制反向输出（ID后4字节转换）</option>
            <option value="dec10_wg26">10位10进制 + WG26</option>
            <option value="dec10_wg26_space">10位10进制 + 空格 + WG26</option>
            <option value="dec10_13">13位10进制</option>
        </select>
        <button onclick="startNFCRead()">点击读取NFC卡</button>
        <div id="nfc-output"></div>
    </div>
    
    <script>
        // 检测浏览器是否支持 Web NFC API
        if (!('NDEFReader' in window)) {
            alert("当前浏览器不支持 Web NFC API，请使用 Chrome 89+ 或其他兼容浏览器。");
        }

        // 将字节数组转换为十六进制字符串
        function bytesToHex(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // 处理卡号数据
        function processCardNumber(serialNumber, type) {
            // 移除冒号，获取纯十六进制字符串
            const cleanHex = serialNumber.replace(/:/g, '');
            let result = '';

            switch(type) {
                case 'hex16_10':
                    result = cleanHex.padStart(10, '0');
                    break;
                case 'hex16_8':
                    result = cleanHex.slice(-8);
                    break;
                case 'hex16_8_reverse':
                    result = cleanHex.slice(-8).split('').reverse().join('');
                    break;
                case 'dec10_5':
                    result = parseInt(cleanHex.slice(-4), 16).toString().padStart(5, '0');
                    break;
                case 'dec10_8_3':
                    result = parseInt(cleanHex.slice(-6), 16).toString().padStart(8, '0');
                    break;
                case 'dec10_8_4':
                    result = parseInt(cleanHex.slice(-8), 16).toString().padStart(8, '0');
                    break;
                case 'dec10_10_3':
                    // 取后6位十六进制（3字节）
                    const last3Bytes = cleanHex.slice(-6);
                    // 确保十进制转换正确 - 15125881 for cde603
                    const decimalValue = parseInt(last3Bytes, 16);
                    // 补零到10位 - 0015125881
                    result = decimalValue.toString().padStart(10, '0');
                    // 添加调试日志
                    console.log('Input:', serialNumber);
                    console.log('Clean hex:', cleanHex);
                    console.log('Last 3 bytes:', last3Bytes);
                    console.log('Decimal:', decimalValue);
                    console.log('Result:', result);
                    break;
                case 'dec10_10_4':
                    result = parseInt(cleanHex.slice(-8), 16).toString().padStart(10, '0');
                    break;
                case 'dec10_10_4_reverse':
                    const reversed = cleanHex.slice(-8).split('').reverse().join('');
                    result = parseInt(reversed, 16).toString().padStart(10, '0');
                    break;
                case 'dec10_wg26':
                    const wg26 = calculateWG26(cleanHex);
                    result = parseInt(cleanHex.slice(-8), 16).toString().padStart(10, '0') + wg26;
                    break;
                case 'dec10_wg26_space':
                    const wg26Space = calculateWG26(cleanHex);
                    result = parseInt(cleanHex.slice(-8), 16).toString().padStart(10, '0') + ' ' + wg26Space;
                    break;
                case 'dec10_13':
                    result = parseInt(cleanHex, 16).toString().padStart(13, '0');
                    break;
                default:
                    result = cleanHex;
            }
            return result;
        }

        // 计算WG26格式
        function calculateWG26(serialNumber) {
            const facilityCode = '0'; // 设施码，通常为0
            const cardNumber = parseInt(serialNumber.slice(-6), 16).toString().padStart(5, '0');
            return facilityCode + cardNumber;
        }

        async function startNFCRead() {
            try {
                const output = document.getElementById('nfc-output');
                const readType = document.getElementById('readType').value;
                output.innerHTML = "正在读取NFC卡，请将卡片靠近...";

                const permission = await navigator.permissions.query({ name: 'nfc' });
                if (permission.state === 'denied') {
                    throw new Error('NFC权限被拒绝');
                }

                const reader = new NDEFReader();
                
                reader.addEventListener('reading', ({ message, serialNumber }) => {
                    let outputText = `原始序列号: ${serialNumber}\n\n`;
                    
                    // 处理并显示转换后的卡号
                    const processedNumber = processCardNumber(serialNumber, readType);
                    outputText = `<div class="result-container">
                        <div>转换后卡号: <span id="card-number">${processedNumber}</span></div>
                        <button onclick="copyToClipboard()" class="copy-button">复制</button>
                    </div>\n`;
                    outputText += `读取类型: ${document.getElementById('readType').options[document.getElementById('readType').selectedIndex].text}\n`;

                    // 详细的调试信息
                    const cleanHex = serialNumber.replace(/:/g, '');
                    outputText += `\n调试信息：\n`;
                    outputText += `清理后的十六进制: ${cleanHex}\n`;
                    outputText += `后3字节(hex): ${cleanHex.slice(-6)}\n`;
                    outputText += `十进制值: ${parseInt(cleanHex.slice(-6), 16)}\n`;
                    outputText += `补零后结果: ${processedNumber}\n`;

                    output.innerHTML = outputText;
                });

                await reader.scan();
                console.log("NFC 读取已启动，请靠近卡片...");
            } catch (error) {
                console.error("NFC 读取失败:", error);
                document.getElementById('nfc-output').innerHTML = `读取失败: ${error.message}`;
            }
        }

        // 复制到剪贴板功能
        async function copyToClipboard() {
            const cardNumber = document.getElementById('card-number').textContent;
            try {
                await navigator.clipboard.writeText(cardNumber);
                const copyButton = document.querySelector('.copy-button');
                copyButton.textContent = '已复制';
                copyButton.classList.add('copy-success');
                setTimeout(() => {
                    copyButton.textContent = '复制';
                    copyButton.classList.remove('copy-success');
                }, 2000);
            } catch (err) {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            }
        }
    </script>

</body>
</html>