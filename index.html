<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        html, body {
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 10px;
            line-height: 1.6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 10px;
        }

        select {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 0 auto 20px;
            display: block;
            background-color: white;
        }

        button {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 18px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 auto 20px;
            display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:active {
            background-color: #0056b3;
        }

        #nfc-output {
            width: 100%;
            max-width: 300px;
            font-size: 16px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 0 auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .sector {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            overflow-x: auto;
        }

        .sector-header {
            font-weight: bold;
            color: #007bff;
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 0 5px;
            }
            
            select, button {
                font-size: 16px;
                padding: 12px;
            }
            
            #nfc-output {
                font-size: 14px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <select id="readType">
            <option value="hex16_10">10位16进制</option>
            <option value="hex16_8">8位16进制</option>
            <option value="hex16_8_reverse">8位16进制反向输出</option>
            <option value="dec10_5">5位10进制（ID后2字节转换）</option>
            <option value="dec10_8_3">8位10进制（ID后3字节转换）</option>
            <option value="dec10_8_4">8位10进制（ID后4字节转换）</option>
            <option value="dec10_10_3" selected>10位10进制（ID后3字节转换）</option>
            <option value="dec10_10_4">10位10进制（ID后4字节转换）</option>
            <option value="dec10_10_4_reverse">10位10进制反向输出（ID后4字节转换）</option>
            <option value="dec10_wg26">10位10进制 + WG26</option>
            <option value="dec10_wg26_space">10位10进制 + 空格 + WG26</option>
            <option value="dec10_13">13位10进制</option>
        </select>
        <button onclick="startNFCRead()">点击读取NFC卡</button>
        <div id="nfc-output"></div>
    </div>
    
    <script>
        // 检测浏览器是否支持 Web NFC API
        if (!('NDEFReader' in window)) {
            alert("当前浏览器不支持 Web NFC API，请使用 Chrome 89+ 或其他兼容浏览器。");
        }

        // 将字节数组转换为十六进制字符串
        function bytesToHex(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // 将字节数组转换为十进制字符串
        function bytesToDec(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(10).padStart(3, '0'))
                .join('');
        }

        // 处理卡号数据
        function processCardNumber(serialNumber, type) {
            const bytes = hexStringToBytes(serialNumber);
            let result = '';

            switch(type) {
                case 'hex16_10':
                    result = serialNumber.padStart(10, '0');
                    break;
                case 'hex16_8':
                    result = serialNumber.slice(-8);
                    break;
                case 'hex16_8_reverse':
                    result = serialNumber.slice(-8).split('').reverse().join('');
                    break;
                case 'dec10_5':
                    result = parseInt(serialNumber.slice(-4), 16).toString().padStart(5, '0');
                    break;
                case 'dec10_8_3':
                    result = parseInt(serialNumber.slice(-6), 16).toString().padStart(8, '0');
                    break;
                case 'dec10_8_4':
                    result = parseInt(serialNumber.slice(-8), 16).toString().padStart(8, '0');
                    break;
                case 'dec10_10_3':
                    result = parseInt(serialNumber.slice(-6), 16).toString().padStart(10, '0');
                    break;
                case 'dec10_10_4':
                    result = parseInt(serialNumber.slice(-8), 16).toString().padStart(10, '0');
                    break;
                case 'dec10_10_4_reverse':
                    result = parseInt(serialNumber.slice(-8).split('').reverse().join(''), 16).toString().padStart(10, '0');
                    break;
                case 'dec10_wg26':
                    const wg26 = calculateWG26(serialNumber);
                    result = parseInt(serialNumber.slice(-8), 16).toString().padStart(10, '0') + wg26;
                    break;
                case 'dec10_wg26_space':
                    const wg26Space = calculateWG26(serialNumber);
                    result = parseInt(serialNumber.slice(-8), 16).toString().padStart(10, '0') + ' ' + wg26Space;
                    break;
                case 'dec10_13':
                    result = parseInt(serialNumber, 16).toString().padStart(13, '0');
                    break;
                default:
                    result = serialNumber;
            }
            return result;
        }

        // 计算WG26格式
        function calculateWG26(serialNumber) {
            // 这里添加WG26格式的计算逻辑
            const facilityCode = '0'; // 设施码，通常为0
            const cardNumber = parseInt(serialNumber.slice(-6), 16).toString().padStart(5, '0');
            return facilityCode + cardNumber;
        }

        // 十六进制字符串转字节数组
        function hexStringToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }

        async function startNFCRead() {
            try {
                const output = document.getElementById('nfc-output');
                const readType = document.getElementById('readType').value;
                output.innerHTML = "正在读取NFC卡，请将卡片靠近...";

                const permission = await navigator.permissions.query({ name: 'nfc' });
                if (permission.state === 'denied') {
                    throw new Error('NFC权限被拒绝');
                }

                const reader = new NDEFReader();
                
                reader.addEventListener('reading', ({ message, serialNumber }) => {
                    let outputText = `原始序列号: ${serialNumber}\n\n`;
                    
                    // 处理并显示转换后的卡号
                    const processedNumber = processCardNumber(serialNumber, readType);
                    outputText += `转换后卡号: ${processedNumber}\n`;
                    outputText += `读取类型: ${document.getElementById('readType').options[document.getElementById('readType').selectedIndex].text}\n`;

                    output.innerHTML = outputText;
                });

                await reader.scan();
                console.log("NFC 读取已启动，请靠近卡片...");
            } catch (error) {
                console.error("NFC 读取失败:", error);
                document.getElementById('nfc-output').innerHTML = `读取失败: ${error.message}`;
            }
        }
    </script>

</body>
</html>